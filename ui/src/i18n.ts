export type Lang = "en" | "zh";

const STORAGE_KEY = "admin_lang";

const TRANSLATIONS: Record<Lang, Record<string, string>> = {
  en: {
    "app.title": "Admin Console",
    "app.subtitle": "v0 management surface",
    "app.token": "Token",
    "app.lang": "Language",
    "app.connected": "Connected to /v0",
    "nav.status": "Status",
    "nav.status.hint": "runtime and health",
    "nav.config": "Config",
    "nav.config.hint": "global config",
    "nav.models": "Models",
    "nav.models.hint": "model config",
    "nav.scripts": "Scripts",
    "nav.scripts.hint": "js scripts",
    "status.title": "Status",
    "status.desc": "Runtime overview and admin surface health.",
    "status.refresh": "Refresh",
    "status.reload": "Reload",
    "status.reloading": "Reloading...",
    "status.card.version": "Version",
    "status.card.uptime": "Uptime (sec)",
    "status.card.loaded": "Loaded at",
    "status.card.mtime": "Config mtime",
    "status.card.models": "Models",
    "status.card.aliases": "Aliases",
    "status.models": "Model IDs",
    "status.aliases": "Alias Names",
    "config.title": "Config",
    "config.desc": "Tune response and routing settings.",
    "config.refresh": "Refresh",
    "config.save": "Save",
    "config.reasoning": "Reasoning Output",
    "config.reasoning.none": "None",
    "config.reasoning.prefix": "Prefix (<think>)",
    "config.reasoning.field": "Field (reasoning_content)",
    "config.reasoning.both": "Both",
    "config.include_usage": "Include usage",
    "config.schema_strict": "Schema strict",
    "config.default_model": "Default model",
    "config.routing.desc": "Route aliases to providers with strategy and ordering.",
    "config.routing.add": "Add Alias",
    "config.routing.empty": "No aliases yet. Add one to start routing.",
    "config.routing.alias": "New alias",
    "config.routing.remove": "Remove",
    "config.routing.name": "Alias name",
    "config.routing.strategy": "Strategy",
    "config.routing.strategy.round_robin": "Round Robin",
    "config.routing.strategy.random": "Random",
    "config.routing.providers": "Providers",
    "config.routing.add_provider": "Add Provider",
    "models.title": "Models",
    "models.desc": "Edit model configuration with a form.",
    "models.refresh": "Refresh",
    "models.new": "New",
    "models.save": "Save",
    "models.delete": "Delete",
    "models.list": "Available Models",
    "models.section": "Model Details",
    "models.id": "Model ID",
    "models.owned_by": "Owned By",
    "models.created": "Created (unix)",
    "models.type": "Type",
    "models.type.static": "Static",
    "models.type.script": "Script",
    "models.static.section": "Static Config",
    "models.static.strategy": "Strategy",
    "models.static.strategy.round_robin": "Round Robin",
    "models.static.strategy.random": "Random",
    "models.static.strategy.match": "Match",
    "models.static.stream": "Stream Chunk Chars",
    "models.static.replies": "Replies",
    "models.static.add": "Add Reply",
    "models.reply.content": "Content",
    "models.reply.reasoning": "Reasoning",
    "models.reply.match": "Match Type",
    "models.reply.match.none": "None",
    "models.reply.match.plain": "Contains",
    "models.reply.match.regex": "Regex",
    "models.reply.match.value": "Match Rules",
    "models.reply.remove": "Remove",
    "models.script.section": "Script Config",
    "models.script.file": "File",
    "models.script.init": "Init File",
    "models.script.timeout": "Timeout (ms)",
    "models.script.stream": "Stream Chunk Chars",
    "scripts.title": "Scripts",
    "scripts.desc": "Edit JS script handlers.",
    "scripts.refresh": "Refresh",
    "scripts.new": "New",
    "scripts.save": "Save",
    "scripts.delete": "Delete",
    "scripts.list": "Scripts",
    "scripts.name": "Script Name",
    "token.title": "Admin Token",
    "token.desc": "Provide admin bearer token for /v0 access. Leave empty if auth is disabled.",
    "token.show": "Show",
    "token.hide": "Hide",
    "token.continue": "Continue without token",
    "token.save": "Save token",
    "notice.token.saved": "Token saved",
    "notice.token.cleared": "Token cleared",
    "notice.token.skip": "Continuing without token",
    "notice.reloaded": "Reloaded",
    "notice.debounced": "Reload debounced",
    "error.load.status": "Failed to load status",
    "error.reload": "Reload failed",
    "error.load.config": "Failed to load config",
    "error.save": "Save failed",
    "notice.config.saved": "Config saved",
    "error.load.models": "Failed to load models",
    "error.load.model": "Failed to load model",
    "error.model.id": "Model id is required",
    "notice.model.saved": "Model saved",
    "notice.model.deleted": "Model deleted",
    "error.delete": "Delete failed",
    "error.load.scripts": "Failed to load scripts",
    "error.load.script": "Failed to load script",
    "error.script.name": "Script name is required",
    "notice.script.saved": "Script saved",
    "notice.script.deleted": "Script deleted",
    "error.match.last": "Match strategy requires the last reply without match",
    "error.match.before": "Match strategy requires only last reply without match",
    "error.routing.alias.name": "Alias name is required",
    "error.routing.alias.providers": "Alias {name} needs at least one provider",
    "confirm.delete.model": "Delete model {id}?",
    "confirm.delete.script": "Delete script {name}?"
  },
  zh: {
    "app.title": "管理控制台",
    "app.subtitle": "v0 管理面板",
    "app.token": "令牌",
    "app.lang": "语言",
    "app.connected": "已连接 /v0",
    "nav.status": "状态",
    "nav.status.hint": "运行与健康",
    "nav.config": "配置",
    "nav.config.hint": "全局配置",
    "nav.models": "模型",
    "nav.models.hint": "模型配置",
    "nav.scripts": "脚本",
    "nav.scripts.hint": "JS 脚本",
    "status.title": "状态",
    "status.desc": "运行概览与管理面板健康检查。",
    "status.refresh": "刷新",
    "status.reload": "重载",
    "status.reloading": "重载中...",
    "status.card.version": "版本",
    "status.card.uptime": "运行时长(秒)",
    "status.card.loaded": "加载时间",
    "status.card.mtime": "配置更新时间",
    "status.card.models": "模型数",
    "status.card.aliases": "别名数",
    "status.models": "模型 ID",
    "status.aliases": "别名名称",
    "config.title": "配置",
    "config.desc": "配置响应与路由策略。",
    "config.refresh": "刷新",
    "config.save": "保存",
    "config.reasoning": "推理输出",
    "config.reasoning.none": "不输出",
    "config.reasoning.prefix": "前缀 <think>",
    "config.reasoning.field": "字段 reasoning_content",
    "config.reasoning.both": "前缀 + 字段",
    "config.include_usage": "返回 usage",
    "config.schema_strict": "严格 schema",
    "config.default_model": "默认模型",
    "config.routing.desc": "为别名配置路由策略与提供方。",
    "config.routing.add": "新增别名",
    "config.routing.empty": "暂无别名，请先添加。",
    "config.routing.alias": "新别名",
    "config.routing.remove": "移除",
    "config.routing.name": "别名",
    "config.routing.strategy": "策略",
    "config.routing.strategy.round_robin": "轮询",
    "config.routing.strategy.random": "随机",
    "config.routing.providers": "提供方",
    "config.routing.add_provider": "添加提供方",
    "models.title": "模型",
    "models.desc": "使用表单编辑模型配置。",
    "models.refresh": "刷新",
    "models.new": "新建",
    "models.save": "保存",
    "models.delete": "删除",
    "models.list": "模型列表",
    "models.section": "模型详情",
    "models.id": "模型 ID",
    "models.owned_by": "所属",
    "models.created": "创建时间(unix)",
    "models.type": "类型",
    "models.type.static": "静态",
    "models.type.script": "脚本",
    "models.static.section": "静态配置",
    "models.static.strategy": "策略",
    "models.static.strategy.round_robin": "轮询",
    "models.static.strategy.random": "随机",
    "models.static.strategy.match": "匹配",
    "models.static.stream": "流式分片字符数",
    "models.static.replies": "回复列表",
    "models.static.add": "新增回复",
    "models.reply.content": "内容",
    "models.reply.reasoning": "推理",
    "models.reply.match": "匹配类型",
    "models.reply.match.none": "无",
    "models.reply.match.plain": "包含",
    "models.reply.match.regex": "正则",
    "models.reply.match.value": "匹配规则",
    "models.reply.remove": "移除",
    "models.script.section": "脚本配置",
    "models.script.file": "脚本文件",
    "models.script.init": "初始化脚本",
    "models.script.timeout": "超时(ms)",
    "models.script.stream": "流式分片字符数",
    "scripts.title": "脚本",
    "scripts.desc": "编辑 JS 脚本处理器。",
    "scripts.refresh": "刷新",
    "scripts.new": "新建",
    "scripts.save": "保存",
    "scripts.delete": "删除",
    "scripts.list": "脚本列表",
    "scripts.name": "脚本名",
    "token.title": "管理令牌",
    "token.desc": "输入 /v0 管理接口的 Bearer Token。未启用鉴权时可留空。",
    "token.show": "显示",
    "token.hide": "隐藏",
    "token.continue": "无令牌继续",
    "token.save": "保存令牌",
    "notice.token.saved": "令牌已保存",
    "notice.token.cleared": "令牌已清除",
    "notice.token.skip": "已无令牌继续",
    "notice.reloaded": "已重载",
    "notice.debounced": "重载被防抖",
    "error.load.status": "状态加载失败",
    "error.reload": "重载失败",
    "error.load.config": "配置加载失败",
    "error.save": "保存失败",
    "notice.config.saved": "配置已保存",
    "error.load.models": "模型列表加载失败",
    "error.load.model": "模型加载失败",
    "error.model.id": "需要填写模型 ID",
    "notice.model.saved": "模型已保存",
    "notice.model.deleted": "模型已删除",
    "error.delete": "删除失败",
    "error.load.scripts": "脚本列表加载失败",
    "error.load.script": "脚本加载失败",
    "error.script.name": "需要填写脚本名",
    "notice.script.saved": "脚本已保存",
    "notice.script.deleted": "脚本已删除",
    "error.match.last": "匹配策略要求最后一条回复不带 match",
    "error.match.before": "匹配策略要求只有最后一条回复可不带 match",
    "error.routing.alias.name": "别名不能为空",
    "error.routing.alias.providers": "别名 {name} 至少需要一个提供方",
    "confirm.delete.model": "确认删除模型 {id}?",
    "confirm.delete.script": "确认删除脚本 {name}?"
  }
};

function detectLang(): Lang {
  if (typeof navigator !== "undefined") {
    const lang = navigator.language.toLowerCase();
    if (lang.startsWith("zh")) {
      return "zh";
    }
  }
  return "en";
}

export function getInitialLang(): Lang {
  if (typeof localStorage === "undefined") {
    return detectLang();
  }
  const stored = localStorage.getItem(STORAGE_KEY);
  if (stored === "en" || stored === "zh") {
    return stored;
  }
  return detectLang();
}

export function saveLang(lang: Lang) {
  if (typeof localStorage !== "undefined") {
    localStorage.setItem(STORAGE_KEY, lang);
  }
}

export function createTranslator(lang: Lang) {
  return (key: string, vars?: Record<string, string | number>) => {
    const template = TRANSLATIONS[lang][key] ?? key;
    if (!vars) {
      return template;
    }
    return Object.keys(vars).reduce(
      (acc, k) => acc.replaceAll(`{${k}}`, String(vars[k])),
      template
    );
  };
}

